<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Doctor</title>
     {% load bootstrap5 %}
  {% bootstrap_css %}
  {% bootstrap_javascript %}

    <meta name="csrf-token" content="{{ csrf_token }}">

   {% load static %}
  <link rel="stylesheet" href="{% static 'CSS/navBar.css' %}">
</head>
<body>
  <style>
      body{
     background: linear-gradient(to right,#a8c0ff, #3f2b96)
      }

        #back-Button {
            background-color: blue;
            color: white; /* Makes the text color white for better visibility */
            border: none; /* Removes the border */
            padding: 10px 20px; /* Adds padding to the button */
            font-size: 16px; /* Sets font size */
            border-radius: 5px; /* Adds rounded corners */
            cursor: pointer; /* Changes the cursor to pointer on hover */
        }

        #back-Button:hover {
            background-color: darkblue; /* Changes color when hovered */
        }

        .nav {
            display: grid;
            grid-template-columns: auto auto; /* Defines two rows */
            gap: 10px; /* Adds space between rows */
            align-items: center; /* Aligns items vertically */
            justify-content: center; /* Aligns items horizontally */
            text-align: center; /* Centers the text */
            margin: 20px; /* Adds some margin around the container */
        }

        h3 {
            margin: 0; /* Removes default margin for h3 */
            font-family: Arial, sans-serif; /* Sets font family */
            color: #333; /* Sets text color */
        }
    </style>
</head>
<body>
 <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="logo-container">
      <div class="logo">
        {% load static %}
        <img src="{% static 'Photos/logo.png' %}" alt="Logo" class="logo-img">
        <h1>HealthCare Portal</h1>
      </div>
    </div>
    <ul class="nav-links">
      <li><a href="/home/doctor">Home</a></li>
      <li><a href="#About us">About us</a></li>
      <li><a href="#Contact">Contact</a></li>
    </ul>
    <div class="top-buttons">
      <div class="notification-container">
        <button class="notification-btn">
          <span class="bell-icon">&#128276;</span>
        </button>
        <div class="dropdown" id="dropdown">
          <tr>
            <p>No new notifications</p>
            <p>No new notifications</p>
          </tr>
        </div>
      </div>

      <div class="notification-container">
        <form action="{% url 'logout' %}" method="POST">
    {% csrf_token %}
    <button class="notification-btn" type="submit">
        Logout
    </button>
</form>


      </div>



    </div>
  </nav>

  <!-- Welcome Message -->
<div id="chartContainer">
    <button id="scrollLeft">◀ Scroll Left</button>
    <div id="myChart" style="width: 100vw; height: 100vh;"></div>
    <button id="scrollRight">Scroll Right ▶</button>
</div>

<div id="myVideo" style="max-width:100vw; height:100vh"></div>
<div id="myPie" style="max-width:100vw; height:100vh"></div>
<div id="becks"  style="max-width:100vw; height:100vh"></div>
</body>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>

  let currentStart = 8; // Current starting hour for the visible range
const visibleRange = 4; // Number of hours visible at a time

function drawChart(data) {
    // Prepare the data for the chart
    const dataToChart = data.map(item => [item[0], item[1]]);
    const dataChart = google.visualization.arrayToDataTable([
        ['Time', 'Sentiment'],
        ...dataToChart
    ]);

    const maxTime = Math.max(...data.map(item => item[0])); // Find the maximum time value

    const options = {
        title: 'Moods vs Time',
        lineWidth: 4,

        hAxis: {
            title: 'Time (Hours)',
            viewWindow: {
                min: currentStart,
                max: currentStart + visibleRange // Show only the defined range
            },
            ticks: Array.from({ length: maxTime }, (_, i) => i), // Generate ticks dynamically
        },
        vAxis: {
            title: 'Sentiment',
            ticks: [0, 0.5, 1], // Define sentiment scale
            gridlines: { count: 3 }
        },
       legend: {
    position: 'left',
    alignment: 'start',
    labeledValues: [
      {value: 1, label: 'Happy'},
      {value: 0.5, label: 'Neutral'},
      {value: 0, label: 'Sad'}
    ]
  },
    };

    const chart = new google.visualization.LineChart(document.getElementById('myChart'));
    chart.draw(dataChart, options);

    // Update navigation buttons
    document.getElementById('scrollLeft').disabled = currentStart <= 0;
    document.getElementById('scrollRight').disabled = currentStart + visibleRange >= maxTime;
}

function fetchDataAndDrawChart() {
    fetch('/api/doctor', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            'userId': '{{userId}}'
        })
    })
    .then(response => response.json())
    .then(data => {
        window.chartData = data; // Store data globally for reuse in scrolling
        drawChart(data);
    })
    .catch(error => {
        console.error('Error fetching data:', error);
    });
}

// Scroll left handler
function scrollLeft() {
    currentStart = Math.max(0, currentStart - visibleRange); // Decrease the start range
    drawChart(window.chartData);
}

// Scroll right handler
function scrollRight() {
    const maxTime = Math.max(...window.chartData.map(item => item[0]));
    currentStart = Math.min(maxTime - visibleRange, currentStart + visibleRange); // Increase the start range
    drawChart(window.chartData);
}

// Event listeners for scroll buttons
document.getElementById('scrollLeft').addEventListener('click', scrollLeft);
document.getElementById('scrollRight').addEventListener('click', scrollRight);

// Initial chart rendering
fetchDataAndDrawChart();

function drawChartVideo() {
    fetch('/api/doctor/video', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()

        },
        body : JSON.stringify({
        userId : {{userId}}
        })
    })
    .then(response => response.json())
    .then(data => {
    console.log(data)
        const dataToChart = data.map(item => [ item[0],item[1]]);
        const dataChart = google.visualization.arrayToDataTable([
            ['Time', 'Sentiment'],
            ...dataToChart
        ]);

        const options = {
            title: 'Moods vs Time',
            hAxis: {
                title: 'Time (Hours)',
                viewWindow: {
                    min: 5,  // Start at 0 hours
                    max: 24  // End at the latest time point in the data
                }
            },
            vAxis: { title: 'Sentiment' },
            legend: 'none'
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('myPie'));
        chart.draw(dataChart, options);
    })
    .catch(error => {
        console.error('Error fetching data:', error);
    });
}


function getBecks(patientId) {
    fetch(`/api/doctor/becks?patientId=${patientId}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log(data); // Handle the returned data here
    })
    .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
    });
}

getBecks({{userId}});
function drawChartVideoPie() {
    fetch('/api/doctor/counts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()

        },
        body : JSON.stringify({
        userId : {{userId}}
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log(data);
        const dataToChart = Object.entries(data.data); // Converts {happy: 85, sad: 25} to [["happy", 85], ["sad", 25]]
    console.log(...dataToChart);
        const dataChart = google.visualization.arrayToDataTable([
            ['Time', 'Sentiment'],
            ...dataToChart
        ]);

        const options = {
            title: 'Moods in Day',
            hAxis: {
                title: 'Time (Hours)',
                viewWindow: {
                    min: 5,  // Start at 0 hours
                    max: 24  // End at the latest time point in the data
                }
            },
            vAxis: { title: 'Sentiment' },
            legend: 'none'
        };

        const chart = new google.visualization.PieChart(document.getElementById('myVideo'));
        chart.draw(dataChart, options);
    })
    .catch(error => {
        console.error('Error fetching data:', error);
    });
}
function getCsrfToken(){
    const token = document.querySelector('meta[name="csrf-token"]');
    return token ? token.content : '';
}

google.charts.load('current', {'packages':['corechart']});
google.charts.setOnLoadCallback(drawChart);
google.charts.setOnLoadCallback(drawChartVideo);
    google.charts.setOnLoadCallback(drawChartVideoPie);
    /*function drawChart() {
    fetch('/api/doctor', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            'userId': '{{userId}}'
        })
    })
    .then(response => response.json())
    .then(data => {
        // Prepare the data for the chart
        const dataToChart = data.map(item => [item[0], item[1]]);
        const dataChart = google.visualization.arrayToDataTable([
            ['Time', 'Sentiment'],
            ...dataToChart
        ]);

        // Find the max time value from the data for dynamic scaling
        const maxTime = Math.max(...data.map(item => item[0])); // Find the maximum time value (in hours)

        const options = {
            title: 'Moods vs Time',
            hAxis: {
                title: 'Time (Hours)',
                viewWindow: {
                    min: 5,   // Always start at 0 hours
                    max: maxTime < 24 ? maxTime : 24  // Dynamic max, but up to 24 hours
                },
                ticks: Array.from({ length: maxTime < 24 ? maxTime : 24 }, (_, i) => i + 1) // Dynamic ticks (1 to maxTime or 24)
            },
            vAxis: {
                title: 'Sentiment',
                ticks: [0, 1],  // Set y-axis ticks to 0 and 1
                format: '0',
                gridlines: {
                    count: 2  // Limit gridlines to 2
                },
                // Custom formatter for y-axis labels
                textStyle: {
                    fontSize: 14
                },
                format: function(value) {
                    if (value === 0) {
                        return 'Sad';
                    } else if (value === 1) {
                        return 'Happy';
                    }
                    return value;
                }
            },
            legend: 'none'
        };

        // Create and draw the chart
        const chart = new google.visualization.LineChart(document.getElementById('myChart'));
        chart.draw(dataChart, options);
    })
    .catch(error => {
        console.error('Error fetching data:', error);
    });
}

*/
    function backToHome(){
    window.location.href = "/home/doctor";
    }
</script>
</html>